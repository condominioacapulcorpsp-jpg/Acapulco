<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Entregas</title>
<style>
/* Estilos b√°sicos, adapte conforme seu CSS */
.hidden { display: none; }
.small { font-size: 0.8em; padding: 4px 8px; margin: 2px; }
.primary { background: #4CAF50; color: #fff; border: none; }
.danger { background: #f44336; color: #fff; border: none; }
.registro-item { border: 1px solid #ccc; margin: 6px 0; padding: 6px; border-radius: 6px; display: flex; justify-content: space-between; }
.registro-fotos img { width: 100px; height: 100px; object-fit: cover; margin-right: 6px; border-radius: 8px; }
</style>
</head>
<body>

<h2>Adicionar Morador</h2>
<input type="text" id="novoNome" placeholder="Nome">
<input type="text" id="novoApto" placeholder="Apto">
<input type="text" id="novoTel" placeholder="Telefone">
<button id="btnAddMorador">Adicionar</button>

<h2>Pesquisar Contato</h2>
<input type="text" id="pesquisa" oninput="filtrarContatos()" placeholder="Pesquisar...">
<select id="contato">
  <option value="">-- Selecione --</option>
</select>

<h2>Registrar Entrega</h2>
<input type="text" id="registroEmpresa" placeholder="Empresa">
<input type="text" id="registroObs" placeholder="Observa√ß√£o">
<button id="btnEnviarWhatsApp">Enviar WhatsApp</button>

<h2>Registros</h2>
<div id="listaRegistros"></div>

<!-- Modal de assinatura -->
<div id="assinaturaModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <canvas id="assinaturaCanvasFull" style="background:#fff; border-radius:8px;"></canvas>
  <button id="assinaturaClear">Limpar</button>
  <button id="assinaturaClose">Fechar</button>
</div>

<!-- Tabs (opcional) -->
<button id="tabEnviarBtn">Enviar</button>
<button id="tabRegistroBtn">Registros</button>
<button id="tabAdminBtn">Admin</button>

<div id="abaEnviar"></div>
<div id="abaRegistro" class="hidden"></div>
<div id="abaAdmin" class="hidden"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoY_0b062upsZ_ohS-_oY3TL66qd4gWc_rXLIiWdS8Qzmk3ydhSqe_XkCgI1J5DTMC/exec";
let contatos = [];
let registros = [];

// ======= Carregar contatos do Google Sheets =======
function carregarContatos(){
  fetch(SCRIPT_URL + "?action=getContatos")
    .then(res => res.json())
    .then(data => {
      contatos = data || [];
      rebuildSelect();
    })
    .catch(err => console.error("Erro ao carregar contatos:", err));
}

// ======= Adicionar Morador =======
document.getElementById('btnAddMorador').onclick = () => {
  const nome = document.getElementById('novoNome').value.trim();
  const apto = document.getElementById('novoApto').value.trim();
  const telefone = document.getElementById('novoTel').value.trim();

  if(!nome || !telefone){
    alert("Preencha pelo menos o nome e o telefone!");
    return;
  }

  const novo = { name: nome, apto: apto || '', phone: telefone, data: new Date().toISOString() };

  fetch(SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: "addContato", contato: novo })
  })
  .then(res => res.json())
  .then(resp => {
    if(resp.result === "success"){
      alert("‚úÖ Contato adicionado!");
      document.getElementById('novoNome').value = '';
      document.getElementById('novoApto').value = '';
      document.getElementById('novoTel').value = '';
      contatos.push(novo);
      rebuildSelect();
    } else {
      alert("‚ùå Erro ao salvar no Google Sheets");
    }
  })
  .catch(err => console.error(err));
};

// ======= Rebuild Select =======
function rebuildSelect(){
  const sel = document.getElementById('contato');
  sel.innerHTML = '<option value="">-- Selecione --</option>';
  contatos.forEach(c => {
    sel.innerHTML += `<option value="${c.phone}">${c.name} - Apt: ${c.apto || ''}</option>`;
  });
}

// ======= Filtrar Contatos =======
function filtrarContatos(){
  const f = document.getElementById('pesquisa').value.toLowerCase();
  const sel = document.getElementById('contato');
  Array.from(sel.options).forEach(o => {
    if(!o.value) return;
    o.style.display = o.text.toLowerCase().includes(f) ? 'block' : 'none';
  });
}

// ======= WhatsApp =======
document.getElementById('btnEnviarWhatsApp').onclick = () => {
  const sel = document.getElementById('contato');
  const numero = sel.value.replace(/\D/g,'');
  if(!numero) return alert("Selecione um morador.");
  const nome = sel.options[sel.selectedIndex].text;
  const empresa = document.getElementById('registroEmpresa').value || '(n√£o informado)';
  const obs = document.getElementById('registroObs').value || '(sem observa√ß√£o)';
  const dataHora = new Date().toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });

  const linkAssinatura = SCRIPT_URL + "?id=" + Date.now();
  const mensagem = `üì¶ Condom√≠nio Cozumel\nOl√°, ${nome}!\nEntrega em ${dataHora}\nEmpresa: ${empresa}\nObserva√ß√£o: ${obs}\nAssine aqui: ${linkAssinatura}`;
  const encodedMsg = encodeURIComponent(mensagem);
  const linkApp = `whatsapp://send?phone=55${numero}&text=${encodedMsg}`;
  const linkWeb = `https://wa.me/55${numero}?text=${encodedMsg}`;
  window.location.href = linkApp;
  setTimeout(()=>{ window.open(linkWeb,'_blank'); },1500);
};

// ======= Renderizar Registros =======
function renderRegistros(){
  const lista = document.getElementById('listaRegistros');
  lista.innerHTML = "";
  if(!registros) return;
  registros.forEach((r,i)=>{
    lista.innerHTML += `
      <div class="registro-item">
        <div class="registro-fotos">
          ${r.foto ? `<img src="${r.foto}">` : `<div style="width:100px;height:100px;background:#ccc;border-radius:8px"></div>`}
          ${r.assinatura ? `<img src="${r.assinatura}">` : ''}
        </div>
        <div class="registro-content">
          <strong>${r.nome} - Apt: ${r.apto}</strong><br>
          ${r.empresa || ''}<br>
          ${r.obs || ''}<br>
          <small>Registro: ${r.data}</small><br>
          ${r.dataBaixa ? `<small>Baixa: ${r.dataBaixa}</small><br>` : ''}
          ${r.assinatura ? '‚úÖ Entrega Confirmada' : `<button class="small primary" onclick="darBaixa(${i})">‚úç Dar Baixa</button>`}
          ${r.linkAssinatura ? `<div style="margin-top:6px"><a href="${r.linkAssinatura}" target="_blank">üîó Link de assinatura</a></div>` : ''}
        </div>
        <button class="small danger" onclick="excluir(${i})">üóë</button>
      </div>`;
  });
}

// ======= Dar Baixa =======
window.darBaixa = (i) => {
  document.getElementById('assinaturaModal').style.display = "flex";
  initCanvas();
};

// ======= Assinatura =======
const canvas = document.getElementById('assinaturaCanvasFull');
const ctx = canvas.getContext('2d');
function initCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 120;
  ctx.lineWidth = 3; ctx.lineCap = "round";
  let draw = false;
  canvas.onpointerdown = e => { draw = true; ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY); };
  canvas.onpointermove = e => { if(draw){ ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); } };
  canvas.onpointerup = () => draw = false;
}
document.getElementById('assinaturaClear').onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); };
document.getElementById('assinaturaClose').onclick = ()=>{ document.getElementById('assinaturaModal').style.display = "none"; };

// ======= Tabs =======
document.getElementById('tabEnviarBtn').onclick = ()=>{ aba('abaEnviar'); };
document.getElementById('tabRegistroBtn').onclick = ()=>{ aba('abaRegistro'); renderRegistros(); };
document.getElementById('tabAdminBtn').onclick = ()=>{ aba('abaAdmin'); };
function aba(id){
  ['abaEnviar','abaRegistro','abaAdmin'].forEach(a=>document.getElementById(a).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ======= Inicializa√ß√£o =======
carregarContatos();

</script>
</body>
</html>

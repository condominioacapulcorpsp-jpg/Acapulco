<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Correspond√™ncia - Condom√≠nio Cozumel</title>

<!-- jsPDF (UMD) para gerar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#2c2f48;
  --nav:#1b2038;
  --active:#1fb954;
  --card:#fff;
  --text-dark:#111;
  --muted:#777;
  --danger:#d9534f;
  --primary:#1B284F;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
body{background:var(--bg);color:#fff;}
.topbar{display:flex;align-items:center;justify-content:space-between;background:var(--nav);padding:12px 18px;color:#fff;flex-wrap:wrap;gap:8px;}
.btn-top, .tab-link{border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;transition:0.2s;}
.btn-top{background:var(--active);color:#000;}
.tab-link{background:transparent;color:#fff;border:1px solid #fff;}
.tab-link:hover, .btn-top:hover{opacity:0.9;}
.container{max-width:700px;margin:20px auto;padding:16px;}
.card{background:var(--card);color:var(--text-dark);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);margin-bottom:20px;}
label{display:block;color:var(--muted);margin-top:10px;font-weight:bold;}
input, select, textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px;font-size:15px;}
textarea{min-height:60px}
button{cursor:pointer;transition:0.2s;}
button:hover{opacity:0.9;}
button.primary{background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;border:none;font-weight:bold;}
button.small{padding:8px 10px;border-radius:6px;border:none;}
button.danger{background:var(--danger);color:#fff;}
button.muted{background:#777;color:#fff;}
.hidden{display:none;}
.registro-item{display:flex;gap:12px;align-items:flex-start;background:#f9f9f9;border-radius:12px;padding:12px;color:#111;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:10px;}
.registro-fotos{display:flex;gap:8px;flex-shrink:0;align-items:center;}
.registro-fotos img, .registro-fotos canvas{width:60px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #ddd;background:#fff;}
.registro-content{flex:1;display:flex;flex-direction:column;}
.registro-content small{color:var(--muted);}
footer{padding:12px;text-align:center;background:var(--nav);color:#fff;margin-top:20px;font-size:14px;}
.assinatura-fullscreen{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;z-index:10000;}
.assinatura-canvas-container{flex:1;display:flex;align-items:center;justify-content:center;padding:10px;}
/* canvas vai ficar com largura/altura via JS (pixels reais), mas o CSS mant√©m apar√™ncia */
canvas#assinaturaCanvasFull{width:60%;height:60%;background:#fff;touch-action:none;border:1px solid #ccc;border-radius:8px;display:block;}
.assinatura-buttons{display:flex;gap:12px;justify-content:center;padding:12px;background:#f0f0f0;}
.assinatura-buttons button{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;}
video, canvas.camera-canvas{width:60%;border-radius:8px;margin-top:8px;}
.result-msg{margin-top:10px;font-weight:bold;}
.admin-table{width:100%;border-collapse:collapse;margin-top:12px;background:transparent;color:var(--text-dark);}
.admin-table th, .admin-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}

/* mini assinatura (thumb) */
.mini-assinatura {
  width:60px;
  height:70px;
  object-fit:contain;
  border:1px solid #aaa;
  border-radius:6px;
  background:#fff;
  margin-left:6px;
}
</style>
</head>
<body>
<div class="topbar">
  <button id="tabEnviarBtn" class="btn-top">üí¨ Enviar WhatsApp</button>
  <button id="tabRegistroBtn" class="tab-link">üì∏ Registros</button>
  <button id="tabAdminBtn" class="tab-link">üë§ Admin Contatos</button>
</div>

<div class="container">

  <!-- Enviar / Registrar -->
  <div id="abaEnviar" class="card">
    <h3>üí¨ Enviar / Registrar Entrega</h3>
    <label>Filtrar contato</label>
    <input id="pesquisa" type="text" placeholder="Ex: nome ou n√∫mero" oninput="filtrarContatos()">
    <label>Contato</label>
    <select id="contato"><option value="">-- Selecione --</option></select>

    <label>Empresa</label>
    <input id="registroEmpresa" type="text" placeholder="Ex: Mercado Livre">
    <label>Observa√ß√£o</label>
    <input id="registroObs" type="text" placeholder="Ex: 2 pacotes">

    <label>Foto da entrega (ou usar c√¢mera)</label>
    <input id="registroFoto" type="file" accept="image/*">
    <video id="cameraVideo" autoplay class="hidden"></video>
    <canvas id="cameraCanvas" class="camera-canvas hidden"></canvas>

    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button id="btnStartCamera" class="small">üì∑ Usar C√¢mera</button>
      <button id="btnCapturePhoto" class="small hidden">üì∏ Capturar</button>
      <button id="btnSalvarRegistro" class="small primary">üíæ Salvar Registro</button>
      <button id="btnEnviarWhatsApp" class="small" style="background:var(--active);color:#000;">üì§ Enviar WhatsApp</button>
    </div>
    <div id="msgResultado" class="result-msg" aria-live="polite"></div>
  </div>

  <!-- Registros -->
  <div id="abaRegistro" class="card hidden">
    <h3>üì∏ Registros de Entrega</h3>
    <div id="listaRegistros"></div>
  </div>

  <!-- Admin -->
  <div id="abaAdmin" class="card hidden">
    <h3>üë§ Gerenciar Contatos</h3>
    <label>Nome</label>
    <input id="novoNome" type="text">
    <label>Apartamento</label>
    <input id="novoApto" type="text">
    <label>Telefone WhatsApp</label>
    <input id="novoTel" type="tel">
    <button id="btnAddMorador" class="primary">‚ûï Adicionar</button>
    <table class="admin-table" id="adminTable"><thead><tr><th>Nome</th><th>Apto</th><th>Telefone</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modal Assinatura -->
<div id="assinaturaModal" class="assinatura-fullscreen" aria-hidden="true">
  <div class="assinatura-canvas-container">
    <canvas id="assinaturaCanvasFull"></canvas>
  </div>
  <div class="assinatura-buttons">
    <button id="assinaturaClear" class="danger">üßπ Limpar</button>
    <button id="assinaturaSave" class="primary">‚úî Salvar</button>
    <button id="assinaturaClose" class="muted">‚ùå Fechar</button>
  </div>
</div>

<footer>Condom√≠nio Cozumel üå¥</footer>

<!-- ====== SCRIPT PRINCIPAL (MODULE) ====== -->
<script type="module">
  // ---- Firebase 9 (modular) - usando a mesma vers√£o que voc√™ j√° tinha
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  // === CONFIG - mantenha seu config (substitua por suas credenciais reais, se quiser)
  const firebaseConfig = {
    apiKey: "AIzaSyCKnhbNKl2ggpdqiidjgBHa6XLDkNwIitA",
    authDomain: "acapulco-5a508.firebaseapp.com",
    projectId: "acapulco-5a508",
    storageBucket: "acapulco-5a508.appspot.com",
    messagingSenderId: "182598654317",
    appId: "1:182598654317:web:2f3b796215fdf0854ce264"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz0iDSfqz3BlYST-3VRXrcEBpffPMhXXhhItT1--KxIVEYgK-fC9LDVo7gxufRpaZzf/exec";
  const SENHA_EXCLUIR = '12345';

  let contatos = [];
  let registros = [];
  let registroIndexAssinatura = null;
  let cameraStream = null, cameraCapturedFile = null;

  // helper para upload -> retorna URL
  async function uploadFile(file, path){
    const refStorage = sRef(storage, path);
    await uploadBytes(refStorage, file);
    return await getDownloadURL(refStorage);
  }

  // ------------------- LISTENERS (real-time Firestore) -------------------
  const contatosCol = collection(db, 'contatos');
  onSnapshot(contatosCol, snapshot => {
    const list = [];
    snapshot.forEach(docSnap => list.push({ id: docSnap.id, ...docSnap.data() }));
    contatos = list;
    rebuildSelect();
    renderAdminTable();
  });

  const registrosQuery = query(collection(db, 'registros'), orderBy('data', 'desc'));
  onSnapshot(registrosQuery, snapshot => {
    const list = [];
    snapshot.forEach(docSnap => list.push({ id: docSnap.id, ...docSnap.data() }));
    registros = list;
    renderRegistros();
  });

  // ------------------- HELPERS -------------------
  function rebuildSelect() {
    const sel = document.getElementById('contato');
    sel.innerHTML = '<option value="">-- Selecione --</option>';
    contatos.forEach(c => {
      sel.innerHTML += `<option value="${c.phone || ''}" data-id="${c.id}">${c.name} - Apt: ${c.apto || ''}</option>`;
    });
  }

  function renderAdminTable(){
    const tbody = document.querySelector('#adminTable tbody');
    tbody.innerHTML = '';
    contatos.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.name}</td><td>${c.apto || ''}</td><td>${c.phone || ''}</td><td>
        <button class="small" onclick="editarContato('${c.id}')">‚úèÔ∏è</button>
        <button class="small danger" onclick="excluirContato('${c.id}')">üóë</button>
      </td>`;
      tbody.appendChild(tr);
    });
  }

  // Expor fun√ß√µes para o escopo global (usadas por onclick inline)
  window.editarContato = async (id) => {
    const c = contatos.find(x=>x.id===id);
    if(!c) return;
    document.getElementById('novoNome').value = c.name;
    document.getElementById('novoApto').value = c.apto || '';
    document.getElementById('novoTel').value = c.phone || '';
    if(confirm('Ao salvar, o contato atual ser√° substitu√≠do. OK para continuar?')){
      await deleteDoc(doc(db, 'contatos', id));
    }
  };

  window.excluirContato = async (id) => {
    const senha = prompt('Senha para excluir:');
    if(senha !== SENHA_EXCLUIR) return alert('Senha incorreta');
    await deleteDoc(doc(db, 'contatos', id));
  };

  // ------------------- ADICIONAR CONTATO -------------------
  document.getElementById('btnAddMorador').addEventListener('click', async ()=>{
    const nome = document.getElementById('novoNome').value.trim();
    const apto = document.getElementById('novoApto').value.trim();
    const tel = document.getElementById('novoTel').value.trim();
    if(!nome || !tel){ alert('Preencha nome e telefone'); return; }
    await addDoc(contatosCol, { name: nome, apto: apto, phone: tel });
    document.getElementById('novoNome').value=''; document.getElementById('novoApto').value=''; document.getElementById('novoTel').value='';
  });

  // ------------------- SALVAR REGISTRO -------------------
  document.getElementById('btnSalvarRegistro').addEventListener('click', async ()=>{
    const sel = document.getElementById('contato');
    const numero = sel.value.replace(/\D/g, '');
    if(!numero) return alert('Selecione um morador.');
    const selectedOption = sel.options[sel.selectedIndex];
    const contatoId = selectedOption?.dataset?.id || '';
    const nome = selectedOption?.text?.split(' - Apt:')[0] || '';
    const empresa = document.getElementById('registroEmpresa').value || '';
    const obs = document.getElementById('registroObs').value || '';
    const dataISO = new Date().toISOString();
    const dataBR = new Date().toLocaleString('pt-BR');

    // criar documento inicial
    const docRef = await addDoc(collection(db, 'registros'), {
      nome: nome,
      apto: contatos.find(c=>c.id===contatoId)?.apto || '',
      phone: numero,
      empresa: empresa,
      obs: obs,
      data: dataISO,
      dataBR: dataBR,
      foto: '',
      assinatura: '',
      linkAssinatura: '',
      dataBaixa: ''
    });

    // se o usu√°rio selecionou arquivo pelo input
    const inputFile = document.getElementById('registroFoto');
    if(inputFile.files && inputFile.files[0]){
      const file = inputFile.files[0];
      // usa helper uploadFile
      const url = await uploadFile(file, `registros/${docRef.id}/foto_${Date.now()}.png`);
      await updateDoc(doc(db, 'registros', docRef.id), { foto: url });
    }

    // se capturou pela c√¢mera
    if(cameraCapturedFile){
      const url = await uploadFile(cameraCapturedFile, `registros/${docRef.id}/foto_camera_${Date.now()}.png`);
      await updateDoc(doc(db, 'registros', docRef.id), { foto: url });
      cameraCapturedFile = null;
    }

    document.getElementById('msgResultado').innerText = 'Registro salvo!';
    setTimeout(()=>{ document.getElementById('msgResultado').innerText = ''; }, 3000);

    // limpar campos
    document.getElementById('registroEmpresa').value=''; document.getElementById('registroObs').value=''; document.getElementById('registroFoto').value='';
  });

  // ------------------- RENDER REGISTROS -------------------
  function renderRegistros(){
    const lista = document.getElementById('listaRegistros');
    lista.innerHTML = "";
    registros.forEach((r,i)=>{
      lista.innerHTML += `
      <div class="registro-item">
        <div class="registro-fotos">
          ${r.foto ? `<img src="${r.foto}">` : `<div style="width:60px;height:70px;background:#ccc;border-radius:8px"></div>`}
          ${r.assinatura ? `<img class="mini-assinatura" src="${r.assinatura}" title="Assinatura">` : `<div style="width:60px;height:70px"></div>`}
        </div>
        <div class="registro-content">
          <strong>${r.nome} - Apt: ${r.apto}</strong><br>
          ${r.empresa || ''}<br>
          ${r.obs || ''}<br>
          <small>Registro: ${r.dataBR || r.data}</small><br>
          ${r.dataBaixa ? `<small>Baixa: ${r.dataBaixa}</small><br>` : ''}
          ${r.assinatura ? `‚úÖ Entrega Confirmada` : `<button class="small primary" onclick="darBaixa('${r.id}')">‚úç Dar Baixa</button>`}
          ${r.linkAssinatura ? `<div style="margin-top:6px"><a href="${r.linkAssinatura}" target="_blank">üîó Link de assinatura</a></div>` : ''}
        </div>
        <button class="small danger" onclick="excluirRegistro('${r.id}')">üóë</button>
      </div>`;
    });
  }

  // ------------------- EXCLUIR REGISTRO -------------------
  window.excluirRegistro = async (id) => {
    const senha = prompt('Senha para excluir:');
    if(senha !== SENHA_EXCLUIR) return alert('Senha incorreta');
    await deleteDoc(doc(db, 'registros', id));
  };

  // ------------------- DAR BAIXA (ASSINATURA) -------------------
  window.darBaixa = (registroId) => {
    registroIndexAssinatura = registroId;
    document.getElementById('assinaturaModal').style.display = 'flex';
    document.getElementById('assinaturaModal').setAttribute('aria-hidden','false');
    initCanvas();
  };

  // ------------------- ASSINATURA (CANVAS) - CORRE√á√ÉO DEFINITIVA -------------------
  const canvas = document.getElementById('assinaturaCanvasFull');
  const ctx = canvas.getContext('2d');

  function initCanvas(){
    // Ajusta tamanho real do canvas (pixels) baseado no container exibido
    const container = document.querySelector('.assinatura-canvas-container');
    const rect = container.getBoundingClientRect();

    // define dimens√µes do canvas em pixels (maior resolu√ß√£o para qualidade)
    const width = Math.round(rect.width * devicePixelRatio);
    const height = Math.round(rect.height * devicePixelRatio);

    canvas.width = width;
    canvas.height = height;

    // ajustar CSS para manter apar√™ncia (o CSS j√° define 60% largura/altura)
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    // escalas para coordenadas corretas
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';

    let drawing = false;

    function getPointerPos(e){
      // suporta pointer events e touch/mouse
      const r = canvas.getBoundingClientRect();
      const clientX = (e.clientX !== undefined) ? e.clientX : (e.touches && e.touches[0].clientX);
      const clientY = (e.clientY !== undefined) ? e.clientY : (e.touches && e.touches[0].clientY);
      // converter para coordenadas no canvas levando em conta devicePixelRatio
      const x = (clientX - r.left) * devicePixelRatio;
      const y = (clientY - r.top) * devicePixelRatio;
      return { x, y };
    }

    // pointer events (funciona em desktop e mobile modernos)
    canvas.onpointerdown = (e) => {
      drawing = true;
      const p = getPointerPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      e.preventDefault();
    };
    canvas.onpointermove = (e) => {
      if(!drawing) return;
      const p = getPointerPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      e.preventDefault();
    };
    canvas.onpointerup = (e) => { drawing = false; e.preventDefault(); };
    canvas.onpointercancel = () => drawing = false;
    canvas.onpointerleave = () => drawing = false;
  }

  document.getElementById('assinaturaClear').onclick = () => {
    // limpa em escala correta
    ctx.clearRect(0,0,canvas.width,canvas.height);
  };
  document.getElementById('assinaturaClose').onclick = () => {
    document.getElementById('assinaturaModal').style.display = 'none';
    document.getElementById('assinaturaModal').setAttribute('aria-hidden','true');
  };

  // ------------------- SALVAR ASSINATURA e GERAR PDF -------------------
  document.getElementById('assinaturaSave').onclick = async ()=> {
    if(!registroIndexAssinatura) return alert('Registro inv√°lido');

    // converte canvas para blob em escala correta
    canvas.toBlob(async (blob) => {
      if(!blob) return alert('Assinatura vazia');

      const fileName = `assinatura_${Date.now()}.png`;
      const storageRef = sRef(storage, `registros/${registroIndexAssinatura}/${fileName}`);

      try {
        // Faz o upload da assinatura
        await uploadBytes(storageRef, blob);

        // Pega a URL p√∫blica
        const url = await getDownloadURL(storageRef);

        const dataBaixaBR = new Date().toLocaleString('pt-BR');

        // Atualiza o documento no Firestore
        await updateDoc(doc(db, 'registros', registroIndexAssinatura), {
          assinatura: url,
          linkAssinatura: url,
          dataBaixa: dataBaixaBR
        });

        document.getElementById('assinaturaModal').style.display = 'none';
        document.getElementById('assinaturaModal').setAttribute('aria-hidden','true');
        alert('‚úÖ Assinatura salva com sucesso!');

        // Gera PDF (opcional) ‚Äî j√° existia no seu fluxo; mantive chamado
        gerarPDF(registroIndexAssinatura);

      } catch (e) {
        console.error("Erro ao salvar assinatura:", e);
        alert("‚ùå Erro ao salvar assinatura. Veja o console.");
      }
    }, 'image/png');
  };

  // ------------------- FILTRAR CONTATOS -------------------
  window.filtrarContatos = function(){
    const f = document.getElementById('pesquisa').value.toLowerCase();
    const sel = document.getElementById('contato');
    Array.from(sel.options).forEach(o => {
      if(!o.value) return;
      o.style.display = o.text.toLowerCase().includes(f) ? 'block' : 'none';
    });
  };

  // ------------------- CAMERA -------------------
  const video = document.getElementById('cameraVideo');
  const canvasCamera = document.getElementById('cameraCanvas');
  document.getElementById('btnStartCamera').onclick = async () => {
    if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream = null; }
    video.classList.remove('hidden'); document.getElementById('btnCapturePhoto').classList.remove('hidden');
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = cameraStream;
  };
  document.getElementById('btnCapturePhoto').onclick = () => {
    canvasCamera.width = video.videoWidth;
    canvasCamera.height = video.videoHeight;
    canvasCamera.getContext('2d').drawImage(video, 0, 0);
    canvasCamera.classList.remove('hidden'); video.classList.add('hidden');
    cameraCapturedFile = dataURLtoFile(canvasCamera.toDataURL('image/png'), 'camera.png');
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
    document.getElementById('btnCapturePhoto').classList.add('hidden');
  };
  function dataURLtoFile(dataurl, filename){
    let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    while(n--){ u8arr[n] = bstr.charCodeAt(n); }
    return new File([u8arr], filename, { type: mime });
  }

  // ------------------- WHATSAPP -------------------
  document.getElementById('btnEnviarWhatsApp').onclick = () => {
    const sel = document.getElementById('contato');
    const numero = sel.value.replace(/\D/g, '');
    if(!numero) return alert("Selecione um morador.");
    const nome = sel.options[sel.selectedIndex].text;
    const empresa = document.getElementById('registroEmpresa').value || '(n√£o informado)';
    const obs = document.getElementById('registroObs').value || '(sem observa√ß√£o)';
    const dataHora = new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

    // pega √∫ltimo registro do mesmo telefone
    const ultimo = registros.find(r => r && r.phone && r.phone.replace(/\D/g,'') === numero) || registros[0];
    const id = ultimo?.id;
    if(!id) return alert("Salve o registro antes de enviar o WhatsApp.");

    const linkAssinatura = ultimo.linkAssinatura || `${SCRIPT_URL}?id=${id}`;
    const mensagem = `üì¶ *Condom√≠nio Cozumel* üå¥\n\nOl√°, ${nome}!\nSua entrega chegou em ${dataHora}.\nüìç Empresa: ${empresa}\nüìù Observa√ß√£o: ${obs}\n\nPor favor, assine o recebimento aqui:\n${linkAssinatura}`;
    const encodedMsg = encodeURIComponent(mensagem);
    const linkApp = `whatsapp://send?phone=55${numero}&text=${encodedMsg}`;
    const linkWeb = `https://wa.me/55${numero}?text=${encodedMsg}`;
    // tenta abrir app, se n√£o abrir, abre web
    window.location.href = linkApp;
    setTimeout(() => { window.open(linkWeb, '_blank'); }, 1500);
  };

  // ------------------- TABS -------------------
  document.getElementById('tabEnviarBtn').onclick = () => { aba('abaEnviar') };
  document.getElementById('tabRegistroBtn').onclick = () => { aba('abaRegistro'); renderRegistros(); };
  document.getElementById('tabAdminBtn').onclick = () => { aba('abaAdmin') };
  function aba(id){
    document.getElementById('abaEnviar').classList.add('hidden');
    document.getElementById('abaRegistro').classList.add('hidden');
    document.getElementById('abaAdmin').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
  }

  // ------------------- GERAR PDF (jsPDF) -------------------
  async function gerarPDF(id){
    try {
      const { jsPDF } = window.jspdf;
      const snap = await getDoc(doc(db, "registros", id));
      if(!snap.exists()) return;
      const r = snap.data();

      const pdf = new jsPDF({ unit:"pt", format:"a4" });
      pdf.setFontSize(16);
      pdf.text("COMPROVANTE DE ENTREGA - Condom√≠nio Cozumel", 40, 50);

      pdf.setFontSize(12);
      pdf.text(`Morador: ${r.nome}`, 40, 90);
      pdf.text(`Apartamento: ${r.apto}`, 40, 110);
      pdf.text(`Empresa: ${r.empresa || '(n√£o informado)'}`, 40, 130);
      pdf.text(`Observa√ß√£o: ${r.obs || '(nenhuma)'}`, 40, 150);
      pdf.text(`Data da baixa: ${r.dataBaixa || ''}`, 40, 170);

      let y = 200;
      // adiciona foto (se existir)
      if(r.foto){
        try {
          const blobFoto = await fetch(r.foto).then(res => res.blob());
          const bitmap = await createImageBitmap(blobFoto);
          const canvasTemp = document.createElement('canvas');
          canvasTemp.width = bitmap.width;
          canvasTemp.height = bitmap.height;
          const ctxTemp = canvasTemp.getContext('2d');
          ctxTemp.drawImage(bitmap,0,0);
          const dataUrl = canvasTemp.toDataURL('image/png');
          pdf.addImage(dataUrl, 'PNG', 40, y, 180, 140);
        } catch(e){ console.warn('Erro ao adicionar foto no PDF', e); }
      }

      // assinatura
      if(r.assinatura){
        try {
          const blobSig = await fetch(r.assinatura).then(res => res.blob());
          const bitmapSig = await createImageBitmap(blobSig);
          const canvasSig = document.createElement('canvas');
          canvasSig.width = bitmapSig.width;
          canvasSig.height = bitmapSig.height;
          const ctxSig = canvasSig.getContext('2d');
          ctxSig.drawImage(bitmapSig,0,0);
          const dataUrlSig = canvasSig.toDataURL('image/png');
          pdf.addImage(dataUrlSig, 'PNG', 240, y, 180, 140);
        } catch(e){ console.warn('Erro ao adicionar assinatura no PDF', e); }
      }

      // baixa o PDF
      pdf.save(`Entrega_${r.nome.replace(/\s+/g,'_')}_Apto_${r.apto}.pdf`);
    } catch(e){
      console.error('Erro gerarPDF:', e);
    }
  }

  // ------------------- UTILIDADES (carregamento inicial) -------------------
  // preenche selects caso contatos n√£o usem onSnapshot imediatamente
  (function initialLoad(){
    // j√° estamos sincronizando com onSnapshot acima; se quiser for√ßar um rebuild agora:
    rebuildSelect();
  })();

</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CorrespondÃªncia - CondomÃ­nio Cozumel</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#2c2f48;
  --nav:#1b2038;
  --active:#1fb954;
  --card:#fff;
  --text-dark:#111;
  --muted:#777;
  --danger:#d9534f;
  --primary:#1B284F;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
body{background:var(--bg);color:#fff;}
.topbar{display:flex;align-items:center;justify-content:space-between;background:var(--nav);padding:12px 18px;color:#fff;flex-wrap:wrap;gap:8px;}
.btn-top,.tab-link{border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;transition:0.2s;}
.btn-top{background:var(--active);color:#000;}
.tab-link{background:transparent;color:#fff;border:1px solid #fff;}
.tab-link:hover,.btn-top:hover{opacity:0.9;}
.container{max-width:700px;margin:20px auto;padding:16px;}
.card{background:var(--card);color:var(--text-dark);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);margin-bottom:20px;}
label{display:block;color:var(--muted);margin-top:10px;font-weight:bold;}
input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px;font-size:15px;}
textarea{min-height:60px}
button{cursor:pointer;transition:0.2s;}
button:hover{opacity:0.9;}
button.primary{background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;border:none;font-weight:bold;}
button.small{padding:8px 10px;border-radius:6px;border:none;}
button.danger{background:var(--danger);color:#fff;}
button.muted{background:#777;color:#fff;}
.hidden{display:none;}
.registro-item{display:flex;gap:12px;align-items:flex-start;background:#f9f9f9;border-radius:12px;padding:12px;color:#111;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:10px;}
.registro-fotos{display:flex;gap:8px;flex-shrink:0;align-items:center;}
.registro-fotos img,.registro-fotos canvas{width:60px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #ddd;background:#fff;}
.registro-content{flex:1;display:flex;flex-direction:column;}
.registro-content small{color:var(--muted);}
footer{padding:12px;text-align:center;background:var(--nav);color:#fff;margin-top:20px;font-size:14px;}
.assinatura-fullscreen{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;z-index:10000;}
.assinatura-canvas-container{flex:1;display:flex;align-items:center;justify-content:center;padding:10px;}
canvas#assinaturaCanvasFull{background:#fff;touch-action:none;border:1px solid #ccc;border-radius:8px;display:block;max-width:90vw;max-height:70vh;width:100%;height:auto;}
.assinatura-buttons{display:flex;gap:12px;justify-content:center;padding:12px;background:#f0f0f0;}
.assinatura-buttons button{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;}
video,canvas.camera-canvas{width:60%;border-radius:8px;margin-top:8px;}
.result-msg{margin-top:10px;font-weight:bold;}
.admin-table{width:100%;border-collapse:collapse;margin-top:12px;background:transparent;color:var(--text-dark);}
.admin-table th,.admin-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.mini-assinatura{width:60px;height:70px;object-fit:contain;border:1px solid #aaa;border-radius:6px;background:#fff;margin-left:6px;}
</style>
</head>
<body>
<div class="topbar">
  <button id="tabEnviarBtn" class="btn-top">ğŸ’¬ Enviar WhatsApp</button>
  <button id="tabRegistroBtn" class="tab-link">ğŸ“¸ Registros</button>
  <button id="tabAdminBtn" class="tab-link">ğŸ‘¤ Admin Contatos</button>
</div>

<div class="container">

  <div id="abaEnviar" class="card">
    <h3>ğŸ’¬ Enviar / Registrar Entrega</h3>
    <label>Filtrar contato</label>
    <input id="pesquisa" type="text" placeholder="Ex: nome ou nÃºmero" oninput="filtrarContatos()">
    <label>Contato</label>
    <select id="contato"><option value="">-- Selecione --</option></select>

    <label>Empresa</label>
    <input id="registroEmpresa" type="text" placeholder="Ex: Mercado Livre">
    <label>ObservaÃ§Ã£o</label>
    <input id="registroObs" type="text" placeholder="Ex: 2 pacotes">

    <label>Foto da entrega (ou usar cÃ¢mera)</label>
    <input id="registroFoto" type="file" accept="image/*">
    <video id="cameraVideo" autoplay class="hidden"></video>
    <canvas id="cameraCanvas" class="camera-canvas hidden"></canvas>

    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button id="btnStartCamera" class="small">ğŸ“· Usar CÃ¢mera</button>
      <button id="btnCapturePhoto" class="small hidden">ğŸ“¸ Capturar</button>
      <button id="btnSalvarRegistro" class="small primary">ğŸ’¾ Salvar Registro</button>
      <button id="btnEnviarWhatsApp" class="small" style="background:var(--active);color:#000;">ğŸ“¤ Enviar WhatsApp</button>
    </div>
    <div id="msgResultado" class="result-msg" aria-live="polite"></div>
  </div>

  <div id="abaRegistro" class="card hidden">
    <h3>ğŸ“¸ Registros de Entrega</h3>
    <div id="listaRegistros"></div>
  </div>

  <div id="abaAdmin" class="card hidden">
    <h3>ğŸ‘¤ Gerenciar Contatos</h3>
    <label>Nome</label>
    <input id="novoNome" type="text">
    <label>Apartamento</label>
    <input id="novoApto" type="text">
    <label>Telefone WhatsApp</label>
    <input id="novoTel" type="tel">
    <button id="btnAddMorador" class="primary">â• Adicionar</button>
    <table class="admin-table" id="adminTable"><thead><tr><th>Nome</th><th>Apto</th><th>Telefone</th><th>AÃ§Ãµes</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="assinaturaModal" class="assinatura-fullscreen" aria-hidden="true">
  <div class="assinatura-canvas-container">
    <canvas id="assinaturaCanvasFull"></canvas>
  </div>
  <div class="assinatura-buttons">
    <button id="assinaturaClear" class="danger">ğŸ§¹ Limpar</button>
    <button id="assinaturaSave" class="primary">âœ” Salvar</button>
    <button id="assinaturaClose" class="muted">âŒ Fechar</button>
  </div>
</div>

<footer>CondomÃ­nio Cozumel ğŸŒ´</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKnhbNKl2ggpdqiidjgBHa6XLDkNwIitA",
  authDomain: "acapulco-5a508.firebaseapp.com",
  projectId: "acapulco-5a508",
  storageBucket: "acapulco-5a508.appspot.com",
  messagingSenderId: "182598654317",
  appId: "1:182598654317:web:2f3b796215fdf0854ce264"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLXNoYlENDq8AibSC308tDJHnbQqyU-0KkZDetuqa56ildHT5bp5XhFdov1vp43AMyfg/exec";
const SENHA_EXCLUIR = '12345';

let contatos = [], registros = [], registroIndexAssinatura = null, cameraCapturedFile = null;

// ========== FIREBASE SNAPSHOTS ==========
onSnapshot(collection(db, 'contatos'), snap => {
  contatos = [];
  snap.forEach(d => contatos.push({ id:d.id, ...d.data() }));
  rebuildSelect();
  renderAdminTable();
});

onSnapshot(query(collection(db,'registros'),orderBy('data','desc')), snap=>{
  registros = [];
  snap.forEach(d => registros.push({ id:d.id, ...d.data() }));
  renderRegistros();
});

// ========== FUNÃ‡Ã•ES ==========
function rebuildSelect(){
  const sel=document.getElementById('contato');
  sel.innerHTML='<option value="">-- Selecione --</option>';
  contatos.forEach(c=>sel.innerHTML+=`<option value="${c.phone}" data-id="${c.id}">${c.name} - Apt: ${c.apto}</option>`);
}

function renderAdminTable(){
  const tb=document.querySelector('#adminTable tbody');
  tb.innerHTML='';
  contatos.forEach(c=>{
    tb.innerHTML+=`<tr><td>${c.name}</td><td>${c.apto}</td><td>${c.phone}</td>
    <td><button class="small" onclick="editarContato('${c.id}')">âœ</button>
    <button class="small danger" onclick="excluirContato('${c.id}')">ğŸ—‘</button></td></tr>`;
  });
}

window.editarContato=async(id)=>{const c=contatos.find(x=>x.id===id);if(!c)return;
document.getElementById('novoNome').value=c.name;
document.getElementById('novoApto').value=c.apto;
document.getElementById('novoTel').value=c.phone;
if(confirm('Salvar substitui contato atual. OK?'))await deleteDoc(doc(db,'contatos',id));};

window.excluirContato=async(id)=>{const s=prompt('Senha:');if(s!==SENHA_EXCLUIR)return alert('Senha incorreta');await deleteDoc(doc(db,'contatos',id));};

document.getElementById('btnAddMorador').onclick=async()=>{
  const n=document.getElementById('novoNome').value.trim();
  const a=document.getElementById('novoApto').value.trim();
  const t=document.getElementById('novoTel').value.trim();
  if(!n||!t)return alert('Preencha nome e telefone');
  await addDoc(collection(db,'contatos'),{name:n,apto:a,phone:t});
  document.getElementById('novoNome').value='';document.getElementById('novoApto').value='';document.getElementById('novoTel').value='';
};

async function uploadFile(file,path){const r=sRef(storage,path);await uploadBytes(r,file);return await getDownloadURL(r);}

document.getElementById('btnSalvarRegistro').onclick=async()=>{
  const sel=document.getElementById('contato');
  const numero=sel.value.replace(/\D/g,'');if(!numero)return alert('Selecione morador');
  const id=sel.options[sel.selectedIndex].dataset.id;
  const nome=sel.options[sel.selectedIndex].text.split(' - Apt:')[0];
  const empresa=document.getElementById('registroEmpresa').value||'';
  const obs=document.getElementById('registroObs').value||'';
  const now=new Date();
  const ref=await addDoc(collection(db,'registros'),{nome,apto:contatos.find(c=>c.id===id)?.apto||'',phone:numero,empresa,obs,data:now.toISOString(),dataBR:now.toLocaleString('pt-BR'),foto:'',assinatura:'',linkAssinatura:'',dataBaixa:''});
  const input=document.getElementById('registroFoto');
  if(input.files[0]){const url=await uploadFile(input.files[0],`registros/${ref.id}/foto.png`);await updateDoc(doc(db,'registros',ref.id),{foto:url});}
  if(cameraCapturedFile){const url=await uploadFile(cameraCapturedFile,`registros/${ref.id}/foto_camera.png`);await updateDoc(doc(db,'registros',ref.id),{foto:url});cameraCapturedFile=null;}
  document.getElementById('msgResultado').innerText='Registro salvo!';
  setTimeout(()=>document.getElementById('msgResultado').innerText='',3000);
  document.getElementById('registroEmpresa').value='';document.getElementById('registroObs').value='';document.getElementById('registroFoto').value='';
};

function renderRegistros(){
  const lista=document.getElementById('listaRegistros');
  lista.innerHTML='';
  registros.forEach(r=>{
    lista.innerHTML+=`<div class="registro-item">
    <div class="registro-fotos">
      ${r.foto?`<img src="${r.foto}">`:`<div style="width:60px;height:70px;background:#ccc;border-radius:8px"></div>`}
      ${r.assinatura?`<img class="mini-assinatura" src="${r.assinatura}">`:`<div style="width:60px;height:70px"></div>`}
    </div>
    <div class="registro-content"><strong>${r.nome} - Apt: ${r.apto}</strong><br>${r.empresa||''}<br>${r.obs||''}<br>
    <small>${r.dataBR}</small><br>${r.dataBaixa?`<small>Baixa: ${r.dataBaixa}</small><br>`:''}
    ${r.assinatura?`âœ… Entrega Confirmada`:`<button class="small primary" onclick="darBaixa('${r.id}')">âœ Dar Baixa</button>`}</div>
    <button class="small danger" onclick="excluirRegistro('${r.id}')">ğŸ—‘</button></div>`;
  });
}

// ===== ABAS =====
const abaEnviar=document.getElementById('abaEnviar'),abaRegistro=document.getElementById('abaRegistro'),abaAdmin=document.getElementById('abaAdmin');
document.getElementById('tabEnviarBtn').onclick=()=>{abaEnviar.classList.remove('hidden');abaRegistro.classList.add('hidden');abaAdmin.classList.add('hidden');};
document.getElementById('tabRegistroBtn').onclick=()=>{abaEnviar.classList.add('hidden');abaRegistro.classList.remove('hidden');abaAdmin.classList.add('hidden');};
document.getElementById('tabAdminBtn').onclick=()=>{abaEnviar.classList.add('hidden');abaRegistro.classList.add('hidden');abaAdmin.classList.remove('hidden');};

function filtrarContatos(){
  const f=document.getElementById('pesquisa').value.toLowerCase();
  Array.from(document.getElementById('contato').options).forEach(o=>{o.style.display=o.text.toLowerCase().includes(f)?'':'none';});
}

// ===== CAMERA =====
const video=document.getElementById('cameraVideo'),canvas=document.getElementById('cameraCanvas');
document.getElementById('btnStartCamera').onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;video.classList.remove('hidden');
  document.getElementById('btnCapturePhoto').classList.remove('hidden');
};
document.getElementById('btnCapturePhoto').onclick=()=>{
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  canvas.toBlob(b=>{cameraCapturedFile=new File([b],'camera.png',{type:'image/png'});});
  video.srcObject.getTracks().forEach(t=>t.stop());
  video.classList.add('hidden');
  document.getElementById('btnCapturePhoto').classList.add('hidden');
};

// ===== ASSINATURA =====
const modal=document.getElementById('assinaturaModal');
const c=document.getElementById('assinaturaCanvasFull');
const ctx=c.getContext('2d');
let desenhando=false;
function resizeCanvas(){
  c.width=c.clientWidth*2;
  c.height=c.clientHeight*2;
  ctx.scale(2,2);
  ctx.lineWidth=2;
  ctx.lineCap='round';
}
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

c.addEventListener('pointerdown',e=>{desenhando=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
c.addEventListener('pointermove',e=>{if(desenhando){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}});
c.addEventListener('pointerup',()=>desenhando=false);
c.addEventListener('pointerleave',()=>desenhando=false);

document.getElementById('assinaturaClear').onclick=()=>ctx.clearRect(0,0,c.width,c.height);
document.getElementById('assinaturaClose').onclick=()=>modal.style.display='none';

window.darBaixa=(id)=>{
  registroIndexAssinatura=id;
  ctx.clearRect(0,0,c.width,c.height);
  modal.style.display='flex';
};

document.getElementById('assinaturaSave').onclick=async()=>{
  const assinaturaURL=c.toDataURL('image/png');
  const regId=registroIndexAssinatura;
  if(!regId)return;
  const blob=await (await fetch(assinaturaURL)).blob();
  const f=new File([blob],'assinatura.png',{type:'image/png'});
  const url=await uploadFile(f,`registros/${regId}/assinatura.png`);
  const now=new Date().toLocaleString('pt-BR');
  await updateDoc(doc(db,'registros',regId),{assinatura:url,dataBaixa:now});

  // Envia ao Google Sheets
  const reg=registros.find(r=>r.id===regId);
  fetch(SCRIPT_URL,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({nome:reg.nome,apartamento:reg.apto,protocolo:reg.id,assinatura:assinaturaURL})
  });

  modal.style.display='none';
};

// ===== WHATSAPP =====
document.getElementById('btnEnviarWhatsApp').onclick=()=>{
  const sel=document.getElementById('contato');
  const numero=sel.value.replace(/\D/g,'');
  if(!numero)return alert('Selecione morador');
  const nome=sel.options[sel.selectedIndex].text.split(' - Apt:')[0];
  const msg=`OlÃ¡ ${nome}, chegou uma correspondÃªncia para vocÃª na portaria.`;
  window.open(`https://wa.me/55${numero}?text=${encodeURIComponent(msg)}`,'_blank');
};

window.excluirRegistro=async(id)=>{const s=prompt('Senha:');if(s!==SENHA_EXCLUIR)return alert('Senha incorreta');await deleteDoc(doc(db,'registros',id));};

</script>
</body>
</html>
